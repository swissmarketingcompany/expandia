<!DOCTYPE html>
<html lang="en" data-theme="bumblebee">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edit Offer - Expandia Admin</title>
    <link href="../dist/css/output.css" rel="stylesheet">
    <link rel="icon" type="image/x-icon" href="../favicon.ico">
    <style>
        .admin-container {
            min-height: 100vh;
            background: #f8fafc;
        }
        
        /* Professional header styles */
        .page-header {
            background: linear-gradient(135deg, #18182f 0%, #1a1a35 100%);
            color: white;
            padding: 32px 0;
            border-bottom: 3px solid #e0a82e;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .page-header h1 {
            font-size: 32px;
            font-weight: 700;
            margin: 0;
            color: white;
        }
        
        .page-header .subtitle {
            font-size: 14px;
            color: #cbd5e1;
            margin-top: 8px;
        }
        
        .page-header .meta {
            font-size: 12px;
            color: #94a3b8;
            margin-top: 12px;
        }
        
        /* Flip card styles */
        .flip-container {
            perspective: 1000px;
            cursor: pointer;
            height: 600px;
        }
        
        .flip-container.flipped .flipper {
            transform: rotateY(180deg);
        }
        
        .flipper {
            position: relative;
            width: 100%;
            height: 100%;
            transition: transform 0.6s;
            transform-style: preserve-3d;
        }
        
        .front, .back {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            display: flex;
            flex-direction: column;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            background: white;
            overflow: hidden;
        }
        
        .front {
            z-index: 2;
            transform: rotateY(0deg);
            pointer-events: auto;
        }
        
        .back {
            transform: rotateY(180deg);
            background: #1e293b;
            pointer-events: none;
        }
        
        .flip-container.flipped .front {
            pointer-events: none;
        }
        
        .flip-container.flipped .back {
            pointer-events: auto;
        }
        
        #htmlContent {
            font-family: 'Monaco', 'Courier New', monospace;
            font-size: 12px;
            line-height: 1.5;
            color: #e2e8f0;
            background: #0f172a;
            padding: 16px;
            border: none;
            resize: none;
            flex: 1;
        }
        
        #refinement-prompt {
            font-size: 14px;
            resize: vertical;
        }
        
        .textarea {
            resize: vertical;
        }
        
        #preview-iframe {
            width: 100%;
            height: 100%;
            border: none;
            border-radius: 8px;
        }
        
        .preview-placeholder {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            background: #f8fafc;
            border: 2px dashed #cbd5e1;
            border-radius: 8px;
            flex-direction: column;
            gap: 12px;
            color: #64748b;
        }
        
        .flip-hint {
            position: absolute;
            top: 12px;
            right: 12px;
            font-size: 11px;
            background: #e0a82e;
            color: #18182f;
            padding: 6px 12px;
            border-radius: 4px;
            font-weight: 600;
            z-index: 10;
            pointer-events: none;
        }
        
        .details-panel {
            height: fit-content;
            position: sticky;
            top: 24px;
        }
        
        /* Ensure textarea is fully interactive on back */
        .flip-container.flipped #htmlContent {
            pointer-events: auto;
        }
    </style>
</head>
<body class="admin-container">
    <div id="auth-screen" class="min-h-screen flex items-center justify-center px-4">
        <div class="card w-full max-w-md bg-white shadow-2xl">
            <div class="card-body">
                <div class="text-center mb-6">
                    <h1 class="text-3xl font-bold text-primary mb-2">üîê Admin Access</h1>
                    <p class="text-gray-600">Enter admin password to edit offers</p>
                </div>
                <form id="auth-form">
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text font-semibold">Admin Password</span>
                        </label>
                        <input type="password" id="admin-password" class="input input-bordered" required autofocus>
                    </div>
                    <div class="alert alert-error mt-4 hidden" id="auth-error">
                        <span>‚ùå Invalid password</span>
                    </div>
                    <button type="submit" class="btn btn-primary w-full mt-6">Access Admin Panel</button>
                </form>
            </div>
        </div>
    </div>

    <div id="edit-screen" class="hidden">
        <div class="navbar bg-white shadow-md border-b border-gray-200">
            <div class="flex-1">
                <img src="../Expandia-main-logo-koyu-yesil.png" alt="Expandia" style="height: 32px; width: auto;">
            </div>
            <div class="flex-none gap-2">
                <a href="/admin/offers" class="btn btn-ghost btn-sm text-gray-700">All Offers</a>
                <a href="/admin/generate-offer" class="btn btn-ghost btn-sm text-gray-700">New Offer</a>
                <button id="logout-btn" class="btn btn-ghost btn-sm text-gray-700">Logout</button>
            </div>
        </div>

        <div class="page-header">
            <div class="container mx-auto px-4 max-w-7xl">
                <h1>Edit Offer</h1>
                <p class="subtitle">Manage and refine your proposal</p>
                <div class="meta" id="last-updated"></div>
            </div>
        </div>

        <div class="container mx-auto px-4 py-8 max-w-7xl">
            <div id="loading" class="text-center py-12">
                <span class="loading loading-spinner loading-lg text-primary"></span>
                <p class="mt-4 text-gray-600">Loading offer...</p>
            </div>

            <div id="not-found" class="hidden">
                <div class="alert alert-error">
                    <span>‚ùå Offer not found</span>
                </div>
                <a href="/admin/offers" class="btn btn-primary mt-4">Back to Offers</a>
            </div>

            <div id="edit-form-container" class="grid grid-cols-1 lg:grid-cols-3 gap-6 hidden">
                <!-- Details Panel - Left Side -->
                <div class="lg:col-span-1 details-panel">
                    <div class="bg-white shadow-md rounded-lg border border-gray-200">
                        <div class="bg-gradient-to-r from-gray-900 to-gray-800 text-white px-6 py-4 rounded-t-lg border-b border-gray-700">
                            <h2 class="text-lg font-semibold">Offer Details</h2>
                        </div>
                        
                        <form id="offer-form" class="p-6 space-y-4">
                            <div class="form-control">
                                <label class="label py-1">
                                    <span class="label-text text-sm font-semibold text-gray-700">Client Name</span>
                                </label>
                                <input type="text" id="client-name" class="input input-bordered input-sm bg-white text-gray-900" required>
                            </div>

                            <div class="form-control">
                                <label class="label py-1">
                                    <span class="label-text text-sm font-semibold text-gray-700">Offer Title</span>
                                </label>
                                <input type="text" id="offer-title" class="input input-bordered input-sm bg-white text-gray-900" required>
                            </div>

                            <div class="form-control">
                                <label class="label py-1">
                                    <span class="label-text text-sm font-semibold text-gray-700">Unique ID</span>
                                </label>
                                <input type="text" id="unique-id" class="input input-bordered input-sm bg-gray-100 text-gray-600" disabled>
                                <label class="label py-0.5">
                                    <span class="label-text-alt text-xs text-gray-500">Cannot be changed</span>
                                </label>
                            </div>

                            <div class="form-control">
                                <label class="label py-1">
                                    <span class="label-text text-sm font-semibold text-gray-700">Client Password</span>
                                </label>
                                <div class="flex gap-1">
                                    <input type="text" id="client-password" class="input input-bordered input-sm bg-white text-gray-900 flex-1" required>
                                    <button type="button" id="generate-password" class="btn btn-sm btn-outline">Gen</button>
                                </div>
                            </div>

                            <div class="divider my-3"></div>

                            <div class="form-control">
                                <label class="label py-1">
                                    <span class="label-text text-sm font-semibold text-gray-700">AI Refinement</span>
                                </label>
                                <textarea id="refinement-prompt" class="textarea textarea-bordered textarea-sm h-20 bg-white text-gray-900" placeholder="Describe changes needed..."></textarea>
                            </div>

                            <div class="alert alert-info mt-2 hidden p-2" id="refining-message">
                                <span class="text-xs text-gray-700">Processing refinement...</span>
                            </div>

                            <div class="space-y-2">
                                <button type="button" id="refine-btn" class="btn btn-warning btn-sm w-full">Refine with AI</button>
                                <button type="button" id="preview-btn" class="btn btn-outline btn-sm w-full">Show Preview</button>
                                <button type="button" id="duplicate-btn" class="btn btn-secondary btn-sm w-full">Duplicate</button>
                                <button type="submit" class="btn btn-primary btn-sm w-full">Save Changes</button>
                            </div>

                            <div class="alert alert-success mt-2 hidden p-2" id="success-message">
                                <span class="text-xs text-green-700">Changes saved successfully</span>
                            </div>

                            <div class="alert alert-error mt-2 hidden p-2" id="error-message">
                                <span class="text-xs text-red-700" id="error-text">Error occurred</span>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Flip Card - Preview / Code Editor - Right Side -->
                <div class="lg:col-span-2">
                    <div class="flip-container" id="flip-container">
                        <div class="flipper">
                            <!-- Front: Preview -->
                            <div class="front">
                                <div class="flip-hint" onclick="toggleFlip()" style="cursor: pointer;">Click to edit code</div>
                                <div style="flex: 1; padding: 16px; overflow: auto;">
                                    <div id="preview-container" class="preview-placeholder">
                                        <p style="font-size: 16px; font-weight: 500; margin: 0;">Preview</p>
                                        <p style="font-size: 12px; margin: 0;">Click preview button or flip card to see</p>
                                    </div>
                                    <iframe id="preview-iframe" style="display: none;"></iframe>
                                </div>
                            </div>
                            
                            <!-- Back: Code Editor -->
                            <div class="back">
                                <div class="flip-hint" onclick="toggleFlip()" style="background: #0f172a; color: #e2e8f0; border: 1px solid #334155; cursor: pointer;">Click to view preview</div>
                                <textarea id="htmlContent" placeholder="HTML content will appear here..." required></textarea>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentOfferId = null;
        const urlParams = new URLSearchParams(window.location.search);
        const offerId = urlParams.get('id');

        const adminPassword = sessionStorage.getItem('adminAuth');
        if (adminPassword) {
            showEditScreen();
            if (offerId) {
                loadOffer(offerId);
            } else {
                showNotFound();
            }
        }

        // Flip card toggle
        function toggleFlip() {
            const flipContainer = document.getElementById('flip-container');
            flipContainer.classList.toggle('flipped');
        }

        // Auth form
        document.getElementById('auth-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const password = document.getElementById('admin-password').value;
            
            try {
                const response = await fetch('/api/admin/verify', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ password })
                });

                if (response.ok) {
                    sessionStorage.setItem('adminAuth', password);
                    showEditScreen();
                    if (offerId) {
                        loadOffer(offerId);
                    } else {
                        showNotFound();
                    }
                } else {
                    document.getElementById('auth-error').classList.remove('hidden');
                }
            } catch (error) {
                document.getElementById('auth-error').classList.remove('hidden');
            }
        });

        function showEditScreen() {
            document.getElementById('auth-screen').classList.add('hidden');
            document.getElementById('edit-screen').classList.remove('hidden');
        }

        function showNotFound() {
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('not-found').classList.remove('hidden');
        }

        // Logout
        document.getElementById('logout-btn').addEventListener('click', () => {
            sessionStorage.removeItem('adminAuth');
            location.reload();
        });

        // Load offer
        async function loadOffer(id) {
            try {
                const response = await fetch(`/api/admin/offer/${id}`, {
                    headers: {
                        'X-Admin-Password': sessionStorage.getItem('adminAuth')
                    }
                });

                if (!response.ok) {
                    throw new Error('Offer not found');
                }

                const offer = await response.json();
                currentOfferId = offer.id;

                document.getElementById('client-name').value = offer.clientName;
                document.getElementById('offer-title').value = offer.title;
                document.getElementById('unique-id').value = offer.id;
                document.getElementById('client-password').value = offer.password;
                document.getElementById('htmlContent').value = offer.htmlContent;

                const updatedDate = new Date(offer.updatedAt || offer.createdAt);
                document.getElementById('last-updated').textContent = 
                    `Last updated: ${updatedDate.toLocaleString()}`;

                document.getElementById('loading').classList.add('hidden');
                document.getElementById('edit-form-container').classList.remove('hidden');
            } catch (error) {
                console.error('Error loading offer:', error);
                showNotFound();
            }
        }

        // Generate password
        document.getElementById('generate-password').addEventListener('click', () => {
            const chars = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let password = '';
            for (let i = 0; i < 12; i++) {
                password += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            document.getElementById('client-password').value = password;
        });

        // Preview
        document.getElementById('preview-btn').addEventListener('click', () => {
            const htmlContent = document.getElementById('htmlContent').value;
            if (!htmlContent.trim()) {
                alert('Please enter HTML content first');
                return;
            }

            const iframe = document.getElementById('preview-iframe');
            const container = document.getElementById('preview-container');
            
            container.style.display = 'none';
            iframe.style.display = 'block';
            
            const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
            iframeDoc.open();
            iframeDoc.write(htmlContent);
            iframeDoc.close();
            
            // Make sure we're on the preview side
            const flipContainer = document.getElementById('flip-container');
            flipContainer.classList.remove('flipped');
        });

        // Duplicate offer
        document.getElementById('duplicate-btn').addEventListener('click', () => {
            const clientName = document.getElementById('client-name').value;
            const title = document.getElementById('offer-title').value;
            const password = document.getElementById('client-password').value;
            const htmlContent = document.getElementById('htmlContent').value;

            // Store in sessionStorage and redirect to create page
            sessionStorage.setItem('duplicateOffer', JSON.stringify({
                clientName,
                title: title + ' (Copy)',
                password,
                htmlContent
            }));

            window.location.href = '/admin/create-offer';
        });

        // Refine with AI
        document.getElementById('refine-btn').addEventListener('click', () => {
            const refinementPrompt = document.getElementById('refinement-prompt').value;
            if (!refinementPrompt.trim()) {
                alert('Please enter a refinement prompt.');
                return;
            }

            document.getElementById('refining-message').classList.remove('hidden');
            document.getElementById('refine-btn').disabled = true;

            refineOffer(currentOfferId, refinementPrompt)
                .then(updatedOffer => {
                    document.getElementById('refining-message').classList.add('hidden');
                    document.getElementById('refine-btn').disabled = false;

                    document.getElementById('client-name').value = updatedOffer.clientName;
                    document.getElementById('offer-title').value = updatedOffer.title;
                    document.getElementById('unique-id').value = updatedOffer.id;
                    document.getElementById('client-password').value = updatedOffer.password;
                    document.getElementById('htmlContent').value = updatedOffer.htmlContent;

                    const updatedDate = new Date(updatedOffer.updatedAt || updatedOffer.createdAt);
                    document.getElementById('last-updated').textContent = 
                        `Last updated: ${updatedDate.toLocaleString()}`;

                    alert('Offer refined successfully!');
                })
                .catch(error => {
                    document.getElementById('refining-message').classList.add('hidden');
                    document.getElementById('refine-btn').disabled = false;
                    alert('Error refining offer: ' + error.message);
                });
        });

        // Form submission
        document.getElementById('offer-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const offerData = {
                clientName: document.getElementById('client-name').value,
                title: document.getElementById('offer-title').value,
                password: document.getElementById('client-password').value,
                htmlContent: document.getElementById('htmlContent').value
            };

            try {
                const response = await fetch(`/api/admin/update-offer/${currentOfferId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Admin-Password': sessionStorage.getItem('adminAuth')
                    },
                    body: JSON.stringify(offerData)
                });

                const result = await response.json();

                if (response.ok) {
                    document.getElementById('success-message').classList.remove('hidden');
                    document.getElementById('error-message').classList.add('hidden');
                    
                    const updatedDate = new Date();
                    document.getElementById('last-updated').textContent = 
                        `Last updated: ${updatedDate.toLocaleString()}`;

                    setTimeout(() => {
                        document.getElementById('success-message').classList.add('hidden');
                    }, 3000);
                } else {
                    document.getElementById('error-message').classList.remove('hidden');
                    document.getElementById('success-message').classList.add('hidden');
                    document.getElementById('error-text').textContent = result.error || 'Error updating offer';
                }
            } catch (error) {
                document.getElementById('error-message').classList.remove('hidden');
                document.getElementById('success-message').classList.add('hidden');
                document.getElementById('error-text').textContent = 'Network error: ' + error.message;
            }
        });

        // Refine offer with AI (using SSE to avoid timeout)
        async function refineOffer(offerId, refinementPrompt) {
            return new Promise((resolve, reject) => {
                const clientName = document.getElementById('client-name').value;
                const title = document.getElementById('offer-title').value;
                const htmlContent = document.getElementById('htmlContent').value;

                // Use fetch with streaming response
                fetch('/api/admin/refine-offer', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Admin-Password': sessionStorage.getItem('adminAuth')
                    },
                    body: JSON.stringify({
                        html: htmlContent,
                        prompt: refinementPrompt,
                        clientName: clientName,
                        offerTitle: title
                    })
                }).then(response => {
                    if (!response.ok) {
                        throw new Error('Failed to refine offer');
                    }

                    const reader = response.body.getReader();
                    const decoder = new TextDecoder();
                    let buffer = '';

                    function readStream() {
                        reader.read().then(({ done, value }) => {
                            if (done) {
                                return;
                            }

                            buffer += decoder.decode(value, { stream: true });
                            const lines = buffer.split('\n');
                            buffer = lines.pop(); // Keep incomplete line in buffer

                            for (const line of lines) {
                                if (line.startsWith('data: ')) {
                                    const data = line.slice(6);
                                    if (data === '[DONE]') {
                                        return;
                                    }

                                    try {
                                        const parsed = JSON.parse(data);
                                        
                                        if (parsed.type === 'complete') {
                                            resolve({
                                                clientName,
                                                title,
                                                id: offerId,
                                                password: document.getElementById('client-password').value,
                                                htmlContent: parsed.html,
                                                updatedAt: new Date().toISOString(),
                                                createdAt: new Date().toISOString()
                                            });
                                            return;
                                        } else if (parsed.type === 'error') {
                                            reject(new Error(parsed.message));
                                            return;
                                        }
                                    } catch (e) {
                                        // Ignore parse errors for heartbeat messages
                                    }
                                }
                            }

                            readStream();
                        }).catch(reject);
                    }

                    readStream();
                }).catch(reject);
            });
        }

        // Check for duplicate data on page load
        window.addEventListener('load', () => {
            const duplicateData = sessionStorage.getItem('duplicateOffer');
            if (duplicateData && !offerId) {
                const data = JSON.parse(duplicateData);
                document.getElementById('client-name').value = data.clientName;
                document.getElementById('offer-title').value = data.title;
                document.getElementById('client-password').value = data.password;
                document.getElementById('htmlContent').value = data.htmlContent;
                sessionStorage.removeItem('duplicateOffer');
            }
        });
    </script>
</body>
</html>

